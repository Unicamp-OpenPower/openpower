<!DOCTYPE html>
<html lang="en-us">

<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="generator" content="Source Themes Academic 4.4.0">

  

  
  
  
  
  
  

  

  
  
  
    
  
  <meta name="description" content="[data-text] { } [data-text]::after { content: attr(data-text); }  Deploying HTTPS is essential for security, and OpenStack Ansible does it by default. However, if no certificates are provided, it will generate self-signed ones, which although are more secure than no SSL at all, it will trigger a warning when accessing the dashboard in the browser. Luckily, the Let’s Encrypt project provides signed SSL certificates for free.

Let’s Encrypt requires your server to be validated before issuing the certificate.">

  
  <link rel="alternate" hreflang="en-us" href="/post/integrating-openstack-ansible-with-lets-encrypt/">

  


  

  
  
  
  <meta name="theme-color" content="#2962ff">
  

  
  
  
  
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.8.6/css/academicons.min.css" integrity="sha256-uFVgMKfistnJAfoCUQigIl+JfUaP47GrRKjf6CTPVmw=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.0/css/all.css" integrity="sha384-aOkxzJ5uQz7WBObEZcHvV5JvRW3TUc2rNPA7pe3AwnsUohiw1Vj2Rgx2KSOkF5+h" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.css" integrity="sha256-ygkqlh3CYSUri3LhQxzdcm0n1EQvH2Y+U5S2idbLtxs=" crossorigin="anonymous">

    
    
    
      
    
    
      
      
        
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/styles/github.min.css" crossorigin="anonymous" title="hl-light">
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/styles/dracula.min.css" crossorigin="anonymous" title="hl-dark" disabled>
        
      
    

    

    

  

  
  
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Montserrat:400,700|Roboto:400,400italic,700|Roboto+Mono&display=swap">
  

  
  
  
  <link rel="stylesheet" href="/css/academic.min.dd629241ea9333c62c071f4a25f829ff.css">

  

  
  
  

  

  <link rel="manifest" href="/index.webmanifest">
  <link rel="icon" type="image/png" href="/img/icon-32.png">
  <link rel="apple-touch-icon" type="image/png" href="/img/icon-192.png">

  <link rel="canonical" href="/post/integrating-openstack-ansible-with-lets-encrypt/">

  
  
  
  
    
    
  
  
  <meta property="twitter:card" content="summary">
  
  <meta property="og:site_name" content="OpenPOWER@UNICAMP">
  <meta property="og:url" content="/post/integrating-openstack-ansible-with-lets-encrypt/">
  <meta property="og:title" content="Integrating OpenStack Ansible with Let’s Encrypt | OpenPOWER@UNICAMP">
  <meta property="og:description" content="[data-text] { } [data-text]::after { content: attr(data-text); }  Deploying HTTPS is essential for security, and OpenStack Ansible does it by default. However, if no certificates are provided, it will generate self-signed ones, which although are more secure than no SSL at all, it will trigger a warning when accessing the dashboard in the browser. Luckily, the Let’s Encrypt project provides signed SSL certificates for free.

Let’s Encrypt requires your server to be validated before issuing the certificate."><meta property="og:image" content="/img/icon-192.png">
  <meta property="twitter:image" content="/img/icon-192.png"><meta property="og:locale" content="en-us">
  
    
      <meta property="article:published_time" content="2017-12-17T00:00:00&#43;00:00">
    
    <meta property="article:modified_time" content="2017-12-17T00:00:00&#43;00:00">
  

  


  





  <title>Integrating OpenStack Ansible with Let’s Encrypt | OpenPOWER@UNICAMP</title>

</head>

<body id="top" data-spy="scroll" data-offset="70" data-target="#TableOfContents" >

  <aside class="search-results" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between mb-3">
        <div class="col-6">
          <h1>Search</h1>
        </div>
        <div class="col-6 col-search-close">
          <a class="js-search" href="#"><i class="fas fa-times-circle text-muted" aria-hidden="true"></i></a>
        </div>
      </div>

      <div id="search-box">
        
        <input name="q" id="search-query" placeholder="Search..." autocapitalize="off"
        autocomplete="off" autocorrect="off" spellcheck="false" type="search">
        
      </div>

    </section>
    <section class="section-search-results">

      <div id="search-hits">
        
      </div>

    </section>
  </div>
</aside>


  
<nav class="navbar navbar-light fixed-top navbar-expand-lg py-0 compensate-for-scrollbar" id="navbar-main">
  <div class="container">

    
      <a class="navbar-brand" href="/">OpenPOWER@UNICAMP</a>
      
      <button type="button" class="navbar-toggler" data-toggle="collapse"
              data-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
        <span><i class="fas fa-bars"></i></span>
      </button>
      

    
    <div class="collapse navbar-collapse" id="navbar">

      
      
      <ul class="navbar-nav mr-auto">
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#projects"><span>Projects</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#people"><span>People</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#talks"><span>Talks</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#posts"><span>Posts</span></a>
        </li>

        
        

        

        
        
        
          
            
          
        

        
        
        
        
        
        

        <li class="nav-item">
          <a class="nav-link " href="http://openpower.ic.unicamp.br/minicloud/" target="_blank" rel="noopener"><span>Minicloud</span></a>
        </li>

        
        

        

        
        
        
          
            
          
        

        
        
        
        
        
        

        <li class="nav-item">
          <a class="nav-link " href="https://oplab9.parqtec.unicamp.br/" target="_blank" rel="noopener"><span>FTP</span></a>
        </li>

        
        

        

        
        
        
          
            
          
        

        
        
        
        
        
        

        <li class="nav-item">
          <a class="nav-link " href="http://openpowerfoundation.org/" target="_blank" rel="noopener"><span>OpenPOWER Foundation</span></a>
        </li>

        
        

      
      </ul>
      <ul class="navbar-nav ml-auto">
      

        

        
        <li class="nav-item">
          <a class="nav-link js-search" href="#"><i class="fas fa-search" aria-hidden="true"></i></a>
        </li>
        

        

        

      </ul>

    </div>
  </div>
</nav>


  <article class="article" itemscope itemtype="http://schema.org/Article">

  












  

  
  
  
<div class="article-container pt-3">
  <h1 itemprop="name">Integrating OpenStack Ansible with Let’s Encrypt</h1>

  

  
    



<meta content="2017-12-17 00:00:00 &#43;0000 UTC" itemprop="datePublished">
<meta content="2017-12-17 00:00:00 &#43;0000 UTC" itemprop="dateModified">

<div class="article-metadata">

  
  

  
  <span class="article-date">
    
    
      
    
    <time>Dec 17, 2017</time>
  </span>
  

  

  
  <span class="middot-divider"></span>
  <span class="article-reading-time">
    4 min read
  </span>
  

  
  
  

  
  

  
    
<div class="share-box" aria-hidden="true">
  <ul class="share">
    
      
      
      
        
      
      
      
      <li>
        <a href="https://twitter.com/intent/tweet?url=/post/integrating-openstack-ansible-with-lets-encrypt/&amp;text=Integrating%20OpenStack%20Ansible%20with%20Let%e2%80%99s%20Encrypt" target="_blank" rel="noopener" class="share-btn-twitter">
          <i class="fab fa-twitter"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://www.facebook.com/sharer.php?u=/post/integrating-openstack-ansible-with-lets-encrypt/&amp;t=Integrating%20OpenStack%20Ansible%20with%20Let%e2%80%99s%20Encrypt" target="_blank" rel="noopener" class="share-btn-facebook">
          <i class="fab fa-facebook-f"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="mailto:?subject=Integrating%20OpenStack%20Ansible%20with%20Let%e2%80%99s%20Encrypt&amp;body=/post/integrating-openstack-ansible-with-lets-encrypt/" target="_blank" rel="noopener" class="share-btn-email">
          <i class="fas fa-envelope"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://www.linkedin.com/shareArticle?url=/post/integrating-openstack-ansible-with-lets-encrypt/&amp;title=Integrating%20OpenStack%20Ansible%20with%20Let%e2%80%99s%20Encrypt" target="_blank" rel="noopener" class="share-btn-linkedin">
          <i class="fab fa-linkedin-in"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://web.whatsapp.com/send?text=Integrating%20OpenStack%20Ansible%20with%20Let%e2%80%99s%20Encrypt%20/post/integrating-openstack-ansible-with-lets-encrypt/" target="_blank" rel="noopener" class="share-btn-whatsapp">
          <i class="fab fa-whatsapp"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://service.weibo.com/share/share.php?url=/post/integrating-openstack-ansible-with-lets-encrypt/&amp;title=Integrating%20OpenStack%20Ansible%20with%20Let%e2%80%99s%20Encrypt" target="_blank" rel="noopener" class="share-btn-weibo">
          <i class="fab fa-weibo"></i>
        </a>
      </li>
    
  </ul>
</div>


  

</div>

    














  
</div>



  <div class="article-container">

    <div class="article-style" itemprop="articleBody">
      

<style>
    [data-text] {
    }
    [data-text]::after {
      content: attr(data-text);
    }
</style>

<p>Deploying HTTPS is essential for security, and OpenStack Ansible does it by default. However, if no certificates are provided, it will generate self-signed ones, which although are more secure than no SSL at all, it will trigger a warning when accessing the dashboard in the browser. Luckily, the Let’s Encrypt project provides signed SSL certificates for free.</p>

<p><center><img src="browser-warning.png" width="80%" style="padding: 25px 0px"/></center></p>

<p>Let’s Encrypt requires your server to be validated before issuing the certificate. This means it will create a temporary file on your server and then try to access it from their servers, to verify that you control the domain you&rsquo;re trying to get a certificate to.</p>

<p><center><img src="lets-encrypt-validation.png" width="80%" style="padding: 25px 0px"/></center></p>

<p>It can launch a temporary web server to do so, however, this will require to stop your usual web server (e.g. Apache) and lead to a few seconds of downtime. Alternatively, you can provide your web root path. Let’s Encrypt will create the files there, and they will be served directly by your usual web server. This approach does not lead to downtime, but presents some additional challenges when using it with OpenStack Ansible:</p>

<ol>
<li>OpenStack Ansible does not have a web root path out of the box to be used by Let’s Encrypt.</li>
<li>SSL certificates must be provided to HAProxy, which runs on metal, while the Apache server to be used by Let’s Encrypt runs inside a container.</li>
</ol>

<p><center><img src="openstack-ansible.png" width="60%" style="padding: 25px 0px"/></center></p>

<h1 id="installing-openstack-ansible">Installing OpenStack Ansible</h1>

<p>Install OpenStack as usual, without providing any certificates. Self-signed ones will be therefore generated, and we will replace them later.</p>

<h1 id="enable-web-root">Enable web root</h1>

<p>We will not actually create a web root. Since Let’s Encrypt only requires writing on <code>your-domain.com/.well-known</code> directory, we will create an alias to the <code>.well-known</code> path.</p>

<p>Attach to the horizon container. Replace the container name accordingly with your setup. If you don’t know the name, run <code>lxc-ls | grep horizon</code> to get the container name.</p>

<div class="codehilite"><pre><span></span><span data-text="# "></span>lxc-attach -n infra1_horizon_container-XXXXXXXX
</pre></div>

<p>Add the following line to <code>/etc/apache2/sites-enabled/openstack-dashboard.conf</code>, inside the <code>&lt;VirtualHost *:80&gt;</code> tag</p>

<pre><code>Alias /.well-known /var/www/html/.well-known 
</code></pre>

<p>Restart the apache2 service:</p>

<div class="codehilite"><pre><span></span><span data-text="# "></span>service apache2 restart
</pre></div>

<p>Now, we can use <code>/var/www/html</code> as our web root, at least from the Let’s Encrypt Certbot point of view.</p>

<h1 id="getting-the-certificates">Getting the certificates</h1>

<p>Now install the Let’s Encrypt Certbot. The intention is to only get the certificates files, not configure them in Apache. Use the following commands to do so:</p>

<div class="codehilite"><pre><span></span><span data-text="# "></span>apt-get update
<span data-text="# "></span>apt-get install software-properties-common
<span data-text="# "></span>add-apt-repository ppa:certbot/certbot
<span data-text="# "></span>apt-get update
<span data-text="# "></span>apt-get install certbot 
<span data-text="# "></span>certbot certonly
</pre></div>

<p>When asked to choose an authentication method, choose <code>2</code></p>

<div class="codehilite"><pre><span></span>How would you like to authenticate with the ACME CA?
-------------------------------------------------------------------------------
1: Spin up a temporary webserver (standalone)
2: Place files in webroot directory (webroot)
-------------------------------------------------------------------------------
Select the appropriate number [1-2] then [enter] (press &#39;c&#39; to cancel): <strong>2</strong>
</pre></div>

<p>When asked for the webroot, input <code>/var/www/html</code></p>

<div class="codehilite"><pre><span></span>Select the webroot for your-domain.com:
-------------------------------------------------------------------------------
1: Enter a new webroot
-------------------------------------------------------------------------------
Press 1 [enter] to confirm the selection (press &#39;c&#39; to cancel): 1
Input the webroot for unicamp.br: (Enter &#39;c&#39; to cancel): <strong>/var/www/html</strong>
</pre></div>

<p>After this, the certificate files will be placed on <code>/etc/letsencrypt/live/your-domain.com</code></p>

<h1 id="allow-the-container-to-copy-files-to-the-host">Allow the container to copy files to the host</h1>

<p>Generate an SSH key <strong>inside the container</strong>:</p>

<div class="codehilite"><pre><span></span><span data-text="# "></span>ssh-keygen -t rsa
</pre></div>

<p>Print the public key and copy it to the clipboard:</p>

<div class="codehilite"><pre><span></span><span data-text="# "></span>cat /root/.ssh/id_rsa.pub
</pre></div>

<p>Now append the container&rsquo;s public key to the authorized_keys file <strong>in the host</strong>:</p>

<div class="codehilite"><pre><span></span><span data-text="# "></span>echo [PASTE THE COPIED KEY HERE] >> /root/.ssh/authorized_keys
</pre></div>

<p>This will allow the container to copy the certificates to the host using <code>scp</code>.</p>

<h1 id="applying-the-certificates-in-haproxy">Applying the certificates in HAProxy</h1>

<p>To use them in HAProxy, we must concatenate some files. Replace <code>your-domain.com</code> accordingly.
<div class="codehilite"><pre><span></span><span data-text="# "></span>cat /etc/letsencrypt/live/your-domain.com/privkey.pem &gt; /etc/letsencrypt/live/your-domain.com/haproxy.key
<span data-text="# "></span>cat /etc/letsencrypt/live/your-domain.com/cert.pem /etc/letsencrypt/live/your-domain.com/chain.pem /etc/letsencrypt/live/your-domain.com/privkey.pem &gt; /etc/letsencrypt/live/your-domain.com/haproxy.pem
</pre></div></p>

<p>Set the permissions properly:</p>

<div class="codehilite"><pre><span></span><span data-text="# "></span>chmod 640 /etc/letsencrypt/live/your-domain.com/haproxy.key
<span data-text="# "></span>chmod 644 /etc/letsencrypt/live/your-domain.com/haproxy.pem
</pre></div>

<p>Still inside the horizon container, copy the files we just generated to the host. Replace <code>your-domain.com</code> and <code>HOST_IP_ADDRESS</code> accordingly.</p>

<div class="codehilite"><pre><span></span><span data-text="# "></span>scp /etc/letsencrypt/live/your-domain.com/haproxy.* HOST_IP_ADDRESS:/etc/ssl/private
</pre></div>

<p>Now <strong>exit the container</strong> and apply the new certificate:</p>

<div class="codehilite"><pre><span></span><span data-text="# "></span>service haproxy reload
</pre></div>

<p><center><img src="secure.png" width="60%" style="padding: 10px 0px 0px 0px"/></center></p>

<h1 id="renewing-the-certificates-automatically">Renewing the certificates automatically</h1>

<p>As Let’s Encrypt certificates are only valid for 90 days, it is highly advisable to schedule automatic renewing. We can do this using crontab inside the horizon container.</p>

<p>Attach to the horizon container. Replace the container name accordingly with your setup. If you don’t know the name, run <code>lxc-ls | grep horizon</code> to get the container name.</p>

<div class="codehilite"><pre><span></span><span data-text="# "></span>lxc-attach -n infra1_horizon_container-XXXXXXXX
</pre></div>

<p>Open the crontab editor:</p>

<div class="codehilite"><pre><span></span><span data-text="# "></span>crontab -e
</pre></div>

<p>Place this line at the end of the file, replacing <code>your-domain.com</code> and <code>HOST_IP_ADDRESS</code> accordingly.</p>

<pre><code>26 3 * * 5 certbot renew &amp;&amp; cat /etc/letsencrypt/live/your-domain.com/privkey.pem &gt; /etc/letsencrypt/live/your-domain.com/haproxy.key &amp;&amp; cat /etc/letsencrypt/live/your-domain.com/cert.pem /etc/letsencrypt/live/your-domain.com/chain.pem /etc/letsencrypt/live/your-domain.com/privkey.pem &gt; /etc/letsencrypt/live/your-domain.com/haproxy.pem &amp;&amp; scp /etc/letsencrypt/live/your-domain.com/haproxy.* HOST_IP_ADDRESS:/etc/ssl/private &amp;&amp; ssh HOST_IP_ADDRESS service haproxy reload
</code></pre>

<p>This will run every week, but it will only actually renew the certificate at most every 60 days, as only certificates that expire in less than 30 days are renewed. Running it more often than every 60 days makes it safer, as even if it fails to run once after the 60 days window, it will still run again before the certificate expire.</p>

    </div>

    


    



    
      








  
  
  







      
      
    

    

    


  </div>
</article>

      

    
    

    
    
    
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.4/imagesloaded.pkgd.min.js" integrity="sha256-lqvxZrPLtfffUl2G/e7szqSvPBILGbwmsGE1MKlOi0Q=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.6/isotope.pkgd.min.js" integrity="sha256-CBrpuqrMhXwcLLUd5tvQ4euBHCdh7wGlDfNz8vbu/iI=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.js" integrity="sha256-X5PoE3KU5l+JcX+w09p/wHl9AzK333C4hJ2I9S5mD4M=" crossorigin="anonymous"></script>

      

      
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/highlight.min.js" integrity="sha256-aYTdUrn6Ow1DDgh5JTc3aDGnnju48y/1c8s1dgkYPQ8=" crossorigin="anonymous"></script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/languages/r.min.js"></script>
        
      

      
      
    

    
    

    
    
    <script>hljs.initHighlightingOnLoad();</script>
    

    
    
    <script>
      const search_index_filename = "/index.json";
      const i18n = {
        'placeholder': "Search...",
        'results': "results found",
        'no_results': "No results found"
      };
      const content_type = {
        'post': "Posts",
        'project': "Projects",
        'publication' : "Publications",
        'talk' : "Talks"
        };
    </script>
    

    
    

    
    
    <script id="search-hit-fuse-template" type="text/x-template">
      <div class="search-hit" id="summary-{{key}}">
      <div class="search-hit-content">
        <div class="search-hit-name">
          <a href="{{relpermalink}}">{{title}}</a>
          <div class="article-metadata search-hit-type">{{type}}</div>
          <p class="search-hit-description">{{snippet}}</p>
        </div>
      </div>
      </div>
    </script>
    

    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/3.2.1/fuse.min.js" integrity="sha256-VzgmKYmhsGNNN4Ph1kMW+BjoYJM2jV5i4IlFoeZA9XI=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin="anonymous"></script>
    

    
    

    
    

    
    
    
    
    
    
    
    
    
      
    
    
    
    
    <script src="/js/academic.min.16bbb3750feb7244c9bc409a5a4fe678.js"></script>

    






  
  <div class="container">
    <footer class="site-footer">
  

  <p class="powered-by">
    

    Powered by the
    <a href="https://sourcethemes.com/academic/" target="_blank" rel="noopener">Academic theme</a> for
    <a href="https://gohugo.io" target="_blank" rel="noopener">Hugo</a>.

    
    <span class="float-right" aria-hidden="true">
      <a href="#" id="back_to_top">
        <span class="button_icon">
          <i class="fas fa-chevron-up fa-2x"></i>
        </span>
      </a>
    </span>
    
  </p>
</footer>

  </div>
  

  
<div id="modal" class="modal fade" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Cite</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <pre><code class="tex hljs"></code></pre>
      </div>
      <div class="modal-footer">
        <a class="btn btn-outline-primary my-1 js-copy-cite" href="#" target="_blank">
          <i class="fas fa-copy"></i> Copy
        </a>
        <a class="btn btn-outline-primary my-1 js-download-cite" href="#" target="_blank">
          <i class="fas fa-download"></i> Download
        </a>
        <div id="modal-error"></div>
      </div>
    </div>
  </div>
</div>

</body>
</html>
